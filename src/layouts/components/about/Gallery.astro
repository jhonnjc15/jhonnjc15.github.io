---
import { markdownify } from "@lib/utils/textConverter";
const { gallery } = Astro.props;
const { title, description, images } = gallery;

const TARGET_WIDTH = 1200;
const TARGET_HEIGHT = 1300;
const TARGET_ROWS_DESKTOP = 13;
const TARGET_ROWS_MOBILE = 16;
const GAP_PX = 12;

const normalizeImage = (image: any, index: number) => {
  if (typeof image === "string") {
    return {
      src: image,
      alt: title,
      size: "feature",
    };
  }

  return {
    alt: title,
    ...image,
  };
};

const computeLayout = (opts: { width?: number; height?: number; count: number }) => {
  const targetWidth = opts.width || TARGET_WIDTH;
  const targetHeight = opts.height || TARGET_HEIGHT;
  const isDesktop = targetWidth >= 900;
  const columns = isDesktop ? 3 : 2;
  const totalRows = isDesktop ? TARGET_ROWS_DESKTOP : TARGET_ROWS_MOBILE;
  const rowUnit = Math.max(60, Math.floor((targetHeight - GAP_PX * (totalRows - 1)) / totalRows));

  const desktopPlacements = [
    { colStart: 1, cols: 2, rowStart: 1, rows: 8 },
    { colStart: 3, cols: 1, rowStart: 1, rows: 5 },
    { colStart: 3, cols: 1, rowStart: 6, rows: 8 },
    { colStart: 1, cols: 1, rowStart: 9, rows: 5 },
    { colStart: 2, cols: 1, rowStart: 9, rows: 5 },
  ];

  const mobilePlacements = [
    { colStart: 1, cols: 2, rowStart: 1, rows: 8 },
    { colStart: 1, cols: 1, rowStart: 9, rows: 4 },
    { colStart: 2, cols: 1, rowStart: 9, rows: 4 },
    { colStart: 1, cols: 1, rowStart: 13, rows: 4 },
    { colStart: 2, cols: 1, rowStart: 13, rows: 4 },
  ];

  const placements = (isDesktop ? desktopPlacements : mobilePlacements).slice(0, opts.count);

  return { placements, columns, rowUnit };
};

const baseItems = images.map((image: any, index: number) => normalizeImage(image, index));
const { placements, columns, rowUnit } = computeLayout({
  width: TARGET_WIDTH,
  height: TARGET_HEIGHT,
  count: baseItems.length,
});

const galleryItems = baseItems.map((item, index) => ({
  ...item,
  rows: placements[index]?.rows || TARGET_ROWS_DESKTOP,
  cols: placements[index]?.cols || 1,
  rowStart: placements[index]?.rowStart || 1,
  colStart: placements[index]?.colStart || 1,
}));
---

<section class="section">
  <div class="container">
    <div class="row justify-center text-center">
      <div class="col-10 lg:col-8 space-y-3">
        <p class="text-xs uppercase tracking-[0.25em] text-secondary font-semibold" set:html={markdownify(title)} />
        <h2 class="text-3xl md:text-4xl font-extrabold text-default" set:html={markdownify(title)} />
        {description && (
          <p class="text-text-offset leading-relaxed" set:html={markdownify(description)} />
        )}
      </div>
    </div>

    <div class="gallery-shell" id="photo-gallery">
      <div
        class="masonry"
        style={{
          "--columns": columns,
          "--row-unit": `${rowUnit}px`,
          "--gap": `${GAP_PX}px`,
        }}
      >
        {galleryItems.map((image) => (
          <div
            class={`picture-item group ${image.cols > 1 ? "picture-item--wide" : ""}`}
            style={{
              "--rows": image.rows,
              "--cols": image.cols,
              gridColumnStart: image.colStart,
              gridRowStart: image.rowStart,
            }}
          >
            <div class="picture-surface">
              <img
                class="picture-img"
                src={image.src}
                alt={image.alt || title}
                loading="lazy"
              />
            </div>
          </div>
        ))}
      </div>
    </div>
  </div>
</section>

<style lang="scss">
  .gallery-shell {
    position: relative;
    max-width: 76rem;
    margin: 0 auto;
    padding: clamp(1rem, 2.25vw, 1.75rem);
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(238, 243, 255, 0.95));
    border-radius: 22px;
    border: 2px solid rgba(89, 116, 255, 0.14);
    box-shadow: 0 30px 60px -30px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(12, 18, 43, 0.06);
  }

  .masonry {
    display: grid;
    grid-template-columns: repeat(var(--columns, 3), minmax(0, 1fr));
    grid-auto-rows: var(--row-unit, 12px);
    grid-auto-flow: dense;
    gap: var(--gap, 12px);
  }

  .picture-item {
    grid-row-end: span var(--rows, 18);
    grid-column-end: span var(--cols, 1);
    border-radius: 16px;
    overflow: hidden;
    min-height: 140px;
  }

  .picture-item--wide {
    min-height: 180px;
  }

  .picture-surface {
    position: relative;
    height: 100%;
    width: 100%;
    background: rgba(255, 255, 255, 0.78);
    box-shadow: 0 14px 32px -16px rgba(0, 0, 0, 0.35);
    border: 1px solid rgba(15, 23, 42, 0.08);
    border-radius: inherit;
    overflow: hidden;
  }

  .picture-img {
    height: 100%;
    width: 100%;
    object-fit: cover;
    transition: transform 320ms ease-out;
    display: block;
  }

  .group:hover .picture-img,
  .group:focus-visible .picture-img {
    transform: scale(1.04);
  }
</style>
