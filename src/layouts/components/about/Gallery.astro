---
import { markdownify } from "@lib/utils/textConverter";
const { gallery } = Astro.props;
const { title, description, images } = gallery;

const defaultSizes = ["tall", "square", "wide", "medium"];

const sizeMap: Record<string, number> = {
  tall: 30,
  square: 20,
  wide: 16,
  medium: 18,
};

const columnMap: Record<string, number> = {
  tall: 1,
  square: 1,
  medium: 1,
  wide: 2,
};

const galleryItems = images.map((image: any, index: number) => {
  if (typeof image === "string") {
    const size = defaultSizes[index % defaultSizes.length];
    const rows = sizeMap[size] || sizeMap.square;
    return {
      src: image,
      alt: title,
      size,
      rows,
      cols: columnMap[size] || 1,
    };
  }

  const normalizedSize = image.size || defaultSizes[index % defaultSizes.length];
  const rows = image.rows || sizeMap[normalizedSize] || sizeMap.square;

  return {
    ...image,
    size: normalizedSize,
    rows,
    cols: columnMap[normalizedSize] || 1,
  };
});
---

<section class="section">
  <div class="container">
    <div class="row justify-center text-center">
      <div class="col-10 lg:col-8 space-y-3">
        <p class="text-xs uppercase tracking-[0.25em] text-secondary font-semibold" set:html={markdownify(title)} />
        <h2 class="text-3xl md:text-4xl font-extrabold text-default" set:html={markdownify(title)} />
        {description && (
          <p class="text-text-offset leading-relaxed" set:html={markdownify(description)} />
        )}
      </div>
    </div>

    <div class="gallery-shell" id="photo-gallery">
      <div class="masonry">
        {galleryItems.map((image) => (
          <div
            class={`picture-item group ${image.cols > 1 ? "picture-item--wide" : ""}`}
            style={{
              "--rows": image.rows,
              "--cols": image.cols,
            }}
          >
            <div class="picture-surface">
              <img
                class="picture-img"
                src={image.src}
                alt={image.alt || title}
                loading="lazy"
              />
            </div>
          </div>
        ))}
      </div>
    </div>
  </div>
</section>

<style lang="scss">
  .gallery-shell {
    position: relative;
    max-width: 74rem;
    margin: 0 auto;
    padding: clamp(1rem, 2.25vw, 1.75rem);
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(238, 243, 255, 0.95));
    border-radius: 22px;
    border: 2px solid rgba(89, 116, 255, 0.14);
    box-shadow: 0 30px 60px -30px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(12, 18, 43, 0.06);
  }

  .masonry {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    grid-auto-rows: 9px;
    grid-auto-flow: dense;
    gap: clamp(0.75rem, 1.25vw, 1rem);
  }

  @media (min-width: 768px) {
    .masonry {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      grid-auto-rows: 10px;
    }
  }

  @media (min-width: 1200px) {
    .masonry {
      grid-template-columns: repeat(4, minmax(0, 1fr));
      grid-auto-rows: 11px;
    }
  }

  .picture-item {
    grid-row-end: span var(--rows, 18);
    grid-column-end: span var(--cols, 1);
    border-radius: 16px;
    overflow: hidden;
    min-height: 140px;
  }

  .picture-item--wide {
    min-height: 180px;
  }

  .picture-surface {
    position: relative;
    height: 100%;
    width: 100%;
    background: rgba(255, 255, 255, 0.78);
    box-shadow: 0 14px 32px -16px rgba(0, 0, 0, 0.35);
    border: 1px solid rgba(15, 23, 42, 0.08);
    border-radius: inherit;
    overflow: hidden;
  }

  .picture-img {
    height: 100%;
    width: 100%;
    object-fit: cover;
    transition: transform 320ms ease-out;
    display: block;
  }

  .group:hover .picture-img,
  .group:focus-visible .picture-img {
    transform: scale(1.04);
  }
</style>
