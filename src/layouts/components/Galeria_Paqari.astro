---
import "photoswipe/style.css";
import TestimonialSliderPaqari from "@layouts/function-components/TestimonialSliderPaqari";
import { getI18N } from "@i18n/index";
const { galery } = Astro.props;
const { currentLocale } = Astro;
const i18n = getI18N({ currentLocale });
---

<section data-animate="fade-up" class="section reviews">
  <div class="container">
    <div class="text-center space-y-3 max-w-3xl mx-auto">
      <p class="text-xs uppercase tracking-[0.25em] text-secondary font-semibold">{i18n.HOME.gallery_title}</p>
      <h2 class="text-3xl md:text-4xl font-extrabold text-default">{galery.title}</h2>
      <p class="text-text-offset leading-relaxed">{galery.description}</p>
    </div>

    <div class="mt-12" id="paqari-gallery">
      <div class="col-12">
        <TestimonialSliderPaqari list={galery.galery_list} client:load />
      </div>
    </div>
  </div>
</section>

<script>
  async function getImageSize(src) {
    return new Promise((resolve) => {
      const img = new Image();
      img.src = src;
      img.onload = () => {
        resolve({ width: img.naturalWidth, height: img.naturalHeight });
      };
    });
  }

  document.addEventListener("astro:page-load", async () => {
    const galleryEl = document.querySelector("#paqari-gallery");

    if (!galleryEl) return;

    const ensureAnchorSize = async (a) => {
      if (!a || (a.dataset.pswpWidth && a.dataset.pswpHeight)) return;

      const img = a.querySelector("img");
      if (img) {
        const { width, height } = await getImageSize(img.src);
        a.dataset.pswpWidth = width;
        a.dataset.pswpHeight = height;
      }
    };

    const hydrateAnchors = async (root) => {
      const anchors = root.querySelectorAll("a[data-pswp-item]");
      for (const a of anchors) {
        await ensureAnchorSize(a);
      }
    };

    await hydrateAnchors(galleryEl);

    const observer = new MutationObserver(async (mutations) => {
      for (const mutation of mutations) {
        for (const node of mutation.addedNodes) {
          if (!(node instanceof HTMLElement)) continue;
          if (node.matches && node.matches("a[data-pswp-item]")) {
            await ensureAnchorSize(node);
          } else {
            await hydrateAnchors(node);
          }
        }
      }
    });

    observer.observe(galleryEl, { childList: true, subtree: true });

    const { default: PhotoSwipeLightbox } = await import("photoswipe/lightbox");

    const lightbox = new PhotoSwipeLightbox({
      gallery: "#paqari-gallery",
      children: "a[data-pswp-item]",
      pswpModule: () => import("photoswipe"),
      showHideAnimationType: "fade",
      showAnimationDuration: 300,
      hideAnimationDuration: 200,
    });

    lightbox.init();
  });
</script>
