---
import { Image } from 'astro:assets';
import config from "@config/config.json";
import { plainify } from "@lib/utils/textConverter";
import { getI18N } from "@i18n/index";
import { getRelativeLocaleUrl } from "astro:i18n";

const { summary_length } = config.settings;
const { products, product_list } = Astro.props;
const { currentLocale } = Astro;
const i18n = getI18N({ currentLocale });

const enhancedProducts = products.map((item) => {
  const mainImageObj = item.data.images?.find((img) => img.isMain);
  return {
    ...item,
    mainImage: mainImageObj?.src || '/images/default.jpg'
  };
});

const isOddCount = enhancedProducts.length % 2 !== 0;
---
<div class="space-y-4">
  <div class="mb-8 flex flex-col gap-2 md:flex-row md:items-center md:justify-between" data-animate="fade-up">
    <div>
      <h2 class="text-3xl md:text-4xl font-extrabold text-default">{product_list.title}</h2>
    </div>
    <p class="max-w-2xl text-text-offset leading-relaxed" data-animate="fade-right">
      {product_list.description}
    </p>
  </div>

  <div class="grid gap-10 md:grid-cols-2 items-stretch justify-items-stretch" data-animate="zoom-in">
    {
      enhancedProducts.map((item: any, idx: number) => (
        <article class={`relative overflow-hidden rounded-3xl bg-gradient-to-br from-background-offset to-background p-6 shadow-xl transition duration-300 hover:-translate-y-1 hover:shadow-2xl border border-gray-200 dark:border-gray-700 ${isOddCount && idx === enhancedProducts.length - 1 ? "md:col-span-2 md:max-w-3xl md:mx-auto" : ""}`} data-animate={idx % 2 === 0 ? "fade-up" : "fade-right"}>
          <span class="absolute w-3/12 aspect-square bg-gradient-to-tr from-secondary to-green-400 -top-8 right-2 rounded-full blur-3xl opacity-20"></span>
          <div class="relative flex flex-col gap-5 lg:flex-row lg:items-center">
            <div class="lg:w-1/2">
              <div class="relative overflow-hidden rounded-2xl bg-background aspect-[4/3]">
                <Image
                  transition:name={`img-${item.data.id_product}`}
                  class="h-full w-full object-cover"
                  width={640}
                  height={480}
                  src={item.mainImage}
                  alt={item.data.title}
                />
              </div>
            </div>
            <div class="lg:w-1/2 space-y-3">
              <div class="flex items-center gap-3">
                <span class="rounded-full bg-primary/10 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-primary">{item.data.category}</span>
              </div>
              <h3 transition:name={`title-${item.data.id_product}`} class="text-2xl font-semibold leading-tight text-default">
                {item.data.title}
              </h3>
              <p class="text-sm leading-relaxed text-text-offset">
                {plainify(item.data.description?.slice(0, Number(summary_length)))}...
              </p>
              <div class="flex flex-wrap gap-2 pt-2">
                {[item.data.feature_1, item.data.feature_2, item.data.feature_3]
                  .filter(Boolean)
                  .map((feature: string) => (
                    <span class="rounded-full bg-background-offset px-3 py-1 text-xs font-semibold text-text">{feature}</span>
                  ))}
              </div>
              <div class="pt-4">
                <a
                  class="inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-primary to-secondary px-4 py-2 text-sm font-semibold text-white shadow-lg transition hover:scale-[1.02] hover:shadow-2xl"
                  href={getRelativeLocaleUrl(
                    currentLocale ?? '',
                    `/products/${item.data.id_product}`,
                  )}
                >
                  {i18n.COMMON.discover_more}
                  <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14m-7-7 7 7-7 7" />
                  </svg>
                </a>
              </div>
            </div>
          </div>
        </article>
      ))
    }
  </div>
</div>
