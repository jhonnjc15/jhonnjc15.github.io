---
// Parte del servidor (Astro)
import "photoswipe/style.css";
import productsES from '@data/es/products.json';
import productsEN from '@data/en/products.json';

const fallbackLocale = 'es';
const { currentLocale } = Astro

// Selecciona productos seg칰n el idioma
const allProducts = currentLocale === 'en' ? productsEN : productsES;

const { id_product } = Astro.props;

// Buscar el producto con ese ID
const product = allProducts.find(p => p.id_product === id_product);

if (!product) {
  throw new Error(`No se encontr칩 el producto con id_product=${id_product}`);
}

// Obtener las im치genes desde el JSON
const images = product.images || [];
const mainImage = images.find(img => img.isMain);
const galleryImages = images.filter(img => !img.isMain);
---

<div class="flex flex-col gap-y-5" id="galery">
  <div class="rounded-[32px] overflow-hidden border border-gray-200 dark:border-gray-700 bg-gradient-to-br from-background-offset to-background shadow-xl">
    {mainImage && (
      <a
        href={mainImage.src}
        data-pswp-width="400"
        data-pswp-height="400"
        class="block"
      >
        <div class="relative flex items-center justify-center w-full min-h-[320px] md:min-h-[420px] p-4">
          <img
            transition:name={`img-${id_product}`}
            src={mainImage.src}
            class="max-h-[520px] w-full object-contain rounded-2xl transition-transform duration-300 hover:scale-105"
            alt=""
          />
        </div>
      </a>
    )}
  </div>
  <div class="rounded-1 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
    {galleryImages.map((image) => (
      <a
        href={image.src}
        data-pswp-width="400"
        data-pswp-height="400"
        class="block overflow-hidden rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900"
      >
        <div class="aspect-square flex items-center justify-center">
          <img
            src={image.src}
            class="w-full h-full object-contain transition-transform duration-300 hover:scale-105"
            alt=""
          />
        </div>
      </a>
    ))}
  </div>
</div>

<script>
  async function getImageSize(src) {
    return new Promise((resolve) => {
      const img = new Image();
      img.src = src;
      img.onload = () => {
        resolve({ width: img.naturalWidth, height: img.naturalHeight });
      };
    });
  }

  document.addEventListener("astro:page-load", async () => {
    const anchors = document.querySelectorAll("#galery a");

    for (const a of anchors) {
      const img = a.querySelector("img");
      if (img) {
        const { width, height } = await getImageSize(img.src);
        a.dataset.pswpWidth = width;
        a.dataset.pswpHeight = height;
      }
    }

    const { default: PhotoSwipeLightbox } = await import("photoswipe/lightbox");

    const lightbox = new PhotoSwipeLightbox({
      gallery: "#galery",
      children: "a",
      pswpModule: () => import("photoswipe"),
      //showHideAnimationType: 'zoom',
      showHideAnimationType: 'fade', // 游녤 se desvanece al cerrar
      showAnimationDuration: 300,    // (opcional) animaci칩n de apertura
      hideAnimationDuration: 200     // 游녣 duraci칩n de fade-out al cerrar
    });

    lightbox.init();
  });
</script>