---
import Galeria from "./Galeria.astro";
import productsES from "@data/es/products.json";
import productsEN from "@data/en/products.json";
import VideoComponent from "@layouts/function-components/VideoComponent";

const { data_by_id } = Astro.props;
const { currentLocale } = Astro;

const allProducts = currentLocale === "en" ? productsEN : productsES;
const relatedProducts = (data_by_id.related_products ?? [])
  .map((id: number) => allProducts.find((p) => p.id_product === id && p.show !== false))
  .filter(Boolean);

const getYouTubeEmbed = (url: string) => {
  try {
    const parsed = new URL(url);
    if (parsed.hostname.includes("youtube.com")) {
      return parsed.searchParams.get("v");
    }
    if (parsed.hostname.includes("youtu.be")) {
      return parsed.pathname.replace("/", "");
    }
  } catch (e) {
    return undefined;
  }
};

const features = data_by_id.features ?? [];
const blogArticles = data_by_id.blog_articles ?? [];
const pdfGuides = data_by_id.pdf_guides ?? [];
const youtubeVideos = data_by_id.youtube_videos ?? [];
const youtubeEmbeds = youtubeVideos
  .map((video: string) => ({ url: video, id: getYouTubeEmbed(video) }))
  .filter((item: { id?: string }) => !!item.id);
const available = data_by_id.available ?? true;
const contactLabel = currentLocale === "en" ? "Contact Us" : "Contáctanos";
const availabilityLabel = available ? (currentLocale === "en" ? "Available" : "Disponible") : (currentLocale === "en" ? "Unavailable" : "No disponible");
const exchangeRate = 3.7; // PEN to USD
const priceValue = data_by_id.price_soles;
const displayPrice = priceValue !== undefined
  ? (currentLocale === "en"
    ? `$${(priceValue / exchangeRate).toFixed(2)}`
    : `S/. ${priceValue}`)
  : undefined;
const contactPhone = "993896226";
const greeting = currentLocale === "en" ? "Hello!" : "¡Hola!";
const contactMessage = currentLocale === "en"
  ? `${greeting} I would like more information about ${data_by_id.name || data_by_id.title}.`
  : `${greeting} Me gustaría más información sobre ${data_by_id.name || data_by_id.title}.`;
const whatsappLink = `https://api.whatsapp.com/send?phone=51${contactPhone}&text=${encodeURIComponent(contactMessage)}`;

const getProductLink = (id: number) => `/${currentLocale ?? "es"}/products/${id}`;
---

<div class="flex flex-col lg:flex-row gap-12 items-start">
  <!-- Galería -->
  <div class="w-full lg:w-[480px] shrink-0 border border-gray-200 dark:border-gray-700 rounded-xl p-6 shadow-md bg-white dark:bg-gray-900">
    <Galeria id_product={data_by_id.id_product} />
  </div>

  <!-- Detalles del producto -->
  <div class="flex flex-col gap-6 w-full">
    <div class="flex flex-col gap-2">
      <div class="flex flex-wrap items-center gap-3">
        <span class={`inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold ${available ? 'bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-200' : 'bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-200'}`}>
          <span class="inline-block h-2 w-2 rounded-full bg-current"></span>
          {availabilityLabel}
        </span>
        {data_by_id.purchase_context && (
          <span class="inline-flex items-center gap-2 rounded-full bg-background-offset px-3 py-1 text-xs font-semibold text-text">
            {data_by_id.purchase_context}
          </span>
        )}
      </div>
      <h1 class="text-3xl font-bold">{data_by_id.name || data_by_id.title}</h1>
    </div>

    <p class="leading-relaxed text-text-offset">
      {data_by_id.description}
    </p>

    {features.length > 0 && (
      <div class="space-y-2">
        <h3 class="text-lg font-semibold">{currentLocale === "en" ? "Key features" : "Características destacadas"}</h3>
        <ul class="list-disc list-inside space-y-2">
          {features.map((feature: string) => (
            <li>{feature}</li>
          ))}
        </ul>
      </div>
    )}

    <div class="flex flex-wrap items-center gap-3">
      {displayPrice && (
        <div class="text-2xl font-semibold">{displayPrice}</div>
      )}
      {data_by_id.price_note && <span class="text-sm text-text-offset">{data_by_id.price_note}</span>}
    </div>

    <a
      href={whatsappLink}
      target="_blank"
      rel="noreferrer"
      class="inline-flex items-center gap-2 bg-[#25D366] py-3 px-8 rounded-xl shadow hover:brightness-105 transition text-center w-fit text-white font-semibold"
    >
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" class="h-5 w-5 fill-current">
        <path d="M16 3C9.383 3 4 8.383 4 15c0 2.373.654 4.586 1.797 6.477L4 29l7.711-1.754C13.52 28.42 14.73 28.7 16 28.7c6.617 0 12-5.383 12-12S22.617 3 16 3zm0 2c5.54 0 10 4.46 10 10s-4.46 10-10 10c-1.12 0-2.2-.19-3.199-.559l-.398-.141-.422.098-4.211.959.938-4.07.098-.422-.219-.367C7.613 19.55 7 17.317 7 15c0-5.54 4.46-10 10-10zm-.77 4c-.26 0-.637.046-1.02.464-.382.418-1.335 1.305-1.335 3.171 0 1.866 1.37 3.672 1.563 3.93.192.255 2.636 4.215 6.518 5.728.89.347 1.582.278 2.172.171.527-.095 1.622-.663 1.852-1.302.228-.64.228-1.19.16-1.303-.067-.113-.252-.18-.527-.316-.277-.137-1.645-.812-1.897-.904-.253-.093-.438-.139-.626.139-.19.278-.72.902-.882 1.086-.16.186-.327.209-.604.072-.277-.137-1.17-.432-2.23-1.327-.825-.707-1.383-1.58-1.546-1.858-.16-.278-.018-.428.12-.566.125-.124.277-.323.415-.484.139-.162.185-.278.277-.463.093-.186.047-.348-.023-.485-.07-.137-.626-1.504-.855-2.059-.228-.547-.46-.473-.634-.483-.163-.008-.35-.01-.54-.01z" />
      </svg>
      {contactLabel}
    </a>

    {(blogArticles.length > 0 || pdfGuides.length > 0 || youtubeEmbeds.length > 0 || relatedProducts.length > 0) && (
      <div class="space-y-8">
        <div class="grid gap-6 md:grid-cols-2">
          {blogArticles.length > 0 && (
            <div class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 p-6 shadow">
              <h3 class="text-xl font-semibold mb-3">{currentLocale === "en" ? "Linked blog articles" : "Artículos del blog enlazados"}</h3>
              <ul class="space-y-2">
                {blogArticles.map((article: { title: string; url: string }) => (
                  <li>
                    <a class="text-primary hover:underline" href={article.url} target="_blank" rel="noreferrer">
                      {article.title}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          )}

          {pdfGuides.length > 0 && (
            <div class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 p-6 shadow">
              <h3 class="text-xl font-semibold mb-3">{currentLocale === "en" ? "Additional resources" : "Recursos adicionales"}</h3>
              <ul class="space-y-2">
                {pdfGuides.map((guide: { title: string; url: string }) => (
                  <li>
                    <a class="flex items-center gap-2 text-primary hover:underline" href={guide.url} target="_blank" rel="noreferrer">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5v-9m0 0-3 3m3-3 3 3M6.75 19.5h10.5A1.75 1.75 0 0 0 19 17.75V8.31c0-.46-.183-.902-.51-1.227l-3.573-3.573A1.75 1.75 0 0 0 13.69 3H6.75A1.75 1.75 0 0 0 5 4.75v13.5c0 .966.784 1.75 1.75 1.75Z" />
                      </svg>
                      {guide.title}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>

        {youtubeEmbeds.length > 0 && (
          <div class="space-y-3">
            <h3 class="text-xl font-semibold">{currentLocale === "en" ? "Related YouTube videos" : "Videos de YouTube relacionados"}</h3>
            <div class="grid gap-4 md:grid-cols-2">
              {youtubeEmbeds.map((video: { url: string; id: string }) => (
                <div class="overflow-hidden rounded-2xl border border-gray-200 dark:border-gray-700 bg-gradient-to-br from-background via-background-offset to-background shadow">
                  <div class="relative p-3">
                    <div class="absolute inset-3 -z-10 rounded-2xl bg-primary/10 blur-2xl"></div>
                    <VideoComponent
                      client:load
                      src={`https://img.youtube.com/vi/${video.id}/maxresdefault.jpg`}
                      height={520}
                      width={920}
                      title={data_by_id.name || data_by_id.title}
                      video_id={video.id}
                      video_width="w-full"
                      video_height="h-auto"
                    />
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {relatedProducts.length > 0 && (
          <div class="space-y-3">
            <h3 class="text-xl font-semibold">{currentLocale === "en" ? "Related products" : "Productos relacionados"}</h3>
            <div class="flex flex-wrap gap-3">
              {relatedProducts.map((product: any) => (
                <a
                  href={getProductLink(product.id_product)}
                  class="inline-flex items-center gap-2 rounded-full border border-gray-200 dark:border-gray-700 bg-background-offset px-4 py-2 text-sm font-semibold text-text hover:border-primary hover:text-primary"
                >
                  <span class="h-2 w-2 rounded-full bg-primary"></span>
                  {product.name || product.title}
                </a>
              ))}
            </div>
          </div>
        )}
      </div>
    )}
  </div>
</div>
