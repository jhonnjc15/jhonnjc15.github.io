---
import Galeria from "./Galeria.astro";
import productsES from "@data/es/products.json";
import productsEN from "@data/en/products.json";

const { data_by_id } = Astro.props;
const { currentLocale } = Astro;

const allProducts = currentLocale === "en" ? productsEN : productsES;
const relatedProducts = (data_by_id.related_products ?? [])
  .map((id: number) => allProducts.find((p) => p.id_product === id))
  .filter(Boolean);

const features = data_by_id.features ?? [];
const blogArticles = data_by_id.blog_articles ?? [];
const pdfGuides = data_by_id.pdf_guides ?? [];
const youtubeVideos = data_by_id.youtube_videos ?? [];
const available = data_by_id.available ?? true;
const contactLabel = currentLocale === "en" ? "Contact Us" : "Contáctanos";
const availabilityLabel = available ? (currentLocale === "en" ? "Available" : "Disponible") : (currentLocale === "en" ? "Unavailable" : "No disponible");

const getProductLink = (id: number) => `/${currentLocale ?? "es"}/products/${id}`;

const getYouTubeEmbed = (url: string) => {
  try {
    const parsed = new URL(url);
    if (parsed.hostname.includes("youtube.com")) {
      return parsed.searchParams.get("v");
    }
    if (parsed.hostname.includes("youtu.be")) {
      return parsed.pathname.replace("/", "");
    }
  } catch (e) {
    return undefined;
  }
};
---

<div class="flex flex-col lg:flex-row gap-12 items-start">
  <!-- Galería -->
  <div class="w-full lg:w-[480px] shrink-0 border border-gray-200 dark:border-gray-700 rounded-xl p-6 shadow-md bg-white dark:bg-gray-900">
    <Galeria id_product={data_by_id.id_product} />
  </div>

  <!-- Detalles del producto -->
  <div class="flex flex-col gap-6 w-full">
    <div class="flex flex-col gap-2">
      <div class="flex flex-wrap items-center gap-3">
        <span class={`inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold ${available ? 'bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-200' : 'bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-200'}`}>
          <span class="inline-block h-2 w-2 rounded-full bg-current"></span>
          {availabilityLabel}
        </span>
        {data_by_id.purchase_context && (
          <span class="inline-flex items-center gap-2 rounded-full bg-background-offset px-3 py-1 text-xs font-semibold text-text">
            {data_by_id.purchase_context}
          </span>
        )}
      </div>
      <h1 class="text-3xl font-bold">{data_by_id.title}</h1>
    </div>

    <p class="leading-relaxed text-text-offset">
      {data_by_id.description}
    </p>

    {features.length > 0 && (
      <div class="space-y-2">
        <h3 class="text-lg font-semibold">{currentLocale === "en" ? "Key features" : "Características destacadas"}</h3>
        <ul class="list-disc list-inside space-y-2">
          {features.map((feature: string) => (
            <li>{feature}</li>
          ))}
        </ul>
      </div>
    )}

    <div class="flex flex-wrap items-center gap-3">
      {data_by_id.price !== undefined && (
        <div class="text-2xl font-semibold">${data_by_id.price}</div>
      )}
      {data_by_id.price_note && <span class="text-sm text-text-offset">{data_by_id.price_note}</span>}
    </div>

    <a
      href="/"
      class="inline-block bg-primary py-3 px-8 rounded-xl shadow hover:bg-secondary transition text-center w-fit text-white"
    >
      {contactLabel}
    </a>

    {(blogArticles.length > 0 || pdfGuides.length > 0 || youtubeVideos.length > 0 || relatedProducts.length > 0) && (
      <div class="space-y-8">
        <div class="grid gap-6 md:grid-cols-2">
          {blogArticles.length > 0 && (
            <div class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 p-6 shadow">
              <h3 class="text-xl font-semibold mb-3">{currentLocale === "en" ? "Linked blog articles" : "Artículos del blog enlazados"}</h3>
              <ul class="space-y-2">
                {blogArticles.map((article: { title: string; url: string }) => (
                  <li>
                    <a class="text-primary hover:underline" href={article.url} target="_blank" rel="noreferrer">
                      {article.title}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          )}

          {pdfGuides.length > 0 && (
            <div class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 p-6 shadow">
              <h3 class="text-xl font-semibold mb-3">{currentLocale === "en" ? "Guides and PDFs" : "Guías y PDFs"}</h3>
              <ul class="space-y-2">
                {pdfGuides.map((guide: { title: string; url: string }) => (
                  <li>
                    <a class="flex items-center gap-2 text-primary hover:underline" href={guide.url} target="_blank" rel="noreferrer">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5v-9m0 0-3 3m3-3 3 3M6.75 19.5h10.5A1.75 1.75 0 0 0 19 17.75V8.31c0-.46-.183-.902-.51-1.227l-3.573-3.573A1.75 1.75 0 0 0 13.69 3H6.75A1.75 1.75 0 0 0 5 4.75v13.5c0 .966.784 1.75 1.75 1.75Z" />
                      </svg>
                      {guide.title}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>

        {youtubeVideos.length > 0 && (
          <div class="space-y-3">
            <h3 class="text-xl font-semibold">{currentLocale === "en" ? "Related YouTube videos" : "Videos de YouTube relacionados"}</h3>
            <div class="grid gap-4 md:grid-cols-2">
              {youtubeVideos.map((video: string) => {
                const id = getYouTubeEmbed(video);
                const embedUrl = id ? `https://www.youtube.com/embed/${id}` : undefined;
                return (
                  <div class="overflow-hidden rounded-2xl border border-gray-200 dark:border-gray-700 bg-black/80 shadow">
                    {embedUrl ? (
                      <iframe
                        class="aspect-video w-full"
                        src={embedUrl}
                        title={data_by_id.title}
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen
                      ></iframe>
                    ) : (
                      <a class="block p-4 text-primary hover:underline" href={video} target="_blank" rel="noreferrer">
                        {video}
                      </a>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {relatedProducts.length > 0 && (
          <div class="space-y-3">
            <h3 class="text-xl font-semibold">{currentLocale === "en" ? "Related products" : "Productos relacionados"}</h3>
            <div class="flex flex-wrap gap-3">
              {relatedProducts.map((product: any) => (
                <a
                  href={getProductLink(product.id_product)}
                  class="inline-flex items-center gap-2 rounded-full border border-gray-200 dark:border-gray-700 bg-background-offset px-4 py-2 text-sm font-semibold text-text hover:border-primary hover:text-primary"
                >
                  <span class="h-2 w-2 rounded-full bg-primary"></span>
                  {product.title}
                </a>
              ))}
            </div>
          </div>
        )}
      </div>
    )}
  </div>
</div>
