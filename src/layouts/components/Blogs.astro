---
import { Image } from 'astro:assets';
import config from "@config/config.json";
import dateFormat from "@lib/utils/dateFormat";
import readingTime from "@lib/utils/readingTime";
import { humanize, plainify, slugify } from "@lib/utils/textConverter";
import { getRelativeLocaleUrl } from "astro:i18n";
const { summary_length } = config.settings;
const { posts, basePath = config.settings.blog_folder, labels } = Astro.props;
const { currentLocale } = Astro;
const searchPlaceholder = currentLocale === "en" ? "Search blog posts" : "Buscar en el blog";
const searchEmptyLabel = currentLocale === "en" ? "No matching posts found." : "No se encontraron publicaciones que coincidan.";

const enhancedPosts = posts.map((item: any) => {
  const searchableText = [
    item.data.title,
    item.data.description,
    ...(item.data.categories ?? []),
    plainify(item.body?.slice(0, Number(summary_length)) ?? ""),
  ]
    .filter(Boolean)
    .join(" ")
    .toLowerCase();
  return {
    ...item,
    searchableText,
  };
});

const buildPostLink = (slug: string) =>
  getRelativeLocaleUrl(currentLocale ?? '', `/${basePath}/${slug}`);

const buildCategoryLink = (category: string) =>
  getRelativeLocaleUrl(currentLocale ?? '', `/${basePath}/${slugify(category)}`);
---

<div class="space-y-4" data-search-scope="blog">
  <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between rounded-2xl bg-[#EEEEEE] dark:bg-background-offset/60 p-4" data-animate="fade-up">
    <label class="sr-only" for="blog-filter-input">{searchPlaceholder}</label>
    <input
      id="blog-filter-input"
      type="search"
      class="w-full md:max-w-md rounded-full border border-gray-200 bg-white px-4 py-2 text-sm text-gray-700 shadow-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/30"
      placeholder={searchPlaceholder}
      data-search-input
    />
    <p class="text-sm text-gray-600" data-search-count></p>
  </div>
  <p class="text-sm text-gray-600 hidden" data-search-empty>{searchEmptyLabel}</p>

  <div class="row">
  {
    enhancedPosts.map((item: any, idx: number) => (
      <div
        class="mb-10 md:col-6 lg:col-4"
        data-animate={idx % 2 === 0 ? "fade-up" : "zoom-in"}
        data-search-item
        data-search-text={item.searchableText}
      >
        <div class="relative h-full overflow-hidden rounded-3xl bg-white dark:bg-white p-6 shadow-lg transition duration-300 hover:-translate-y-1 hover:shadow-2xl border border-gray-200">
          <div class="relative aspect-[4/3] overflow-hidden rounded-2xl">
            <Image
              class="h-full w-full object-cover"
              width={640}
              height={480}
              src={item.data.image}
              alt={item.data.title}
            />
            <span class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></span>
            <div class="absolute left-4 right-4 top-4 flex flex-wrap gap-2">
              {item.data.categories.map((category: any) => (
                <a
                  class="tag blog-category-tag !border-white/30 !bg-black/30 backdrop-blur"
                  href={buildCategoryLink(category)}
                >
                  {humanize(category)}
                </a>
              ))}
            </div>
          </div>
          <div class="card-content mt-5 space-y-3">
            <p class="text-xs font-semibold uppercase tracking-[0.18em] text-secondary">{labels?.latest_articles_label}</p>
            <h3 class="h4 card-title text-2xl font-bold leading-tight text-gray-900 dark:text-gray-900">
              <a href={buildPostLink(item.slug)} class="hover:text-primary">{item.data.title}</a>
            </h3>
            <p class="mb-4 text-gray-700 dark:text-gray-800 leading-relaxed max-h-24 overflow-hidden">
              {
                item.data.description
                  ? item.data.description
                  : `${plainify(item.body?.slice(0, Number(summary_length)))}...`
              }
            </p>
            <div class="card-footer mt-4 flex flex-wrap items-center gap-4 text-sm text-gray-600 dark:text-gray-700">
              <span class="inline-flex items-center">
                <svg
                  class="mr-1.5"
                  width="14"
                  height="16"
                  viewBox="0 0 14 16"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M12.5 2H11V0.375C11 0.16875 10.8313 0 10.625 0H9.375C9.16875 0 9 0.16875 9 0.375V2H5V0.375C5 0.16875 4.83125 0 4.625 0H3.375C3.16875 0 3 0.16875 3 0.375V2H1.5C0.671875 2 0 2.67188 0 3.5V14.5C0 15.3281 0.671875 16 1.5 16H12.5C13.3281 16 14 15.3281 14 14.5V3.5C14 2.67188 13.3281 2 12.5 2ZM12.3125 14.5H1.6875C1.58438 14.5 1.5 14.4156 1.5 14.3125V5H12.5V14.3125C12.5 14.4156 12.4156 14.5 12.3125 14.5Z"
                    fill="#939393"
                  />
                </svg>
                {dateFormat(item.data.date)}
              </span>
              <span class="inline-flex items-center">
                <svg
                  class="mr-1.5"
                  width="16"
                  height="16"
                  viewBox="0 0 16 16"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M7.65217 0C3.42496 0 0 3.58065 0 8C0 12.4194 3.42496 16 7.65217 16C11.8794 16 15.3043 12.4194 15.3043 8C15.3043 3.58065 11.8794 0 7.65217 0ZM7.65217 14.4516C4.24264 14.4516 1.48107 11.5645 1.48107 8C1.48107 4.43548 4.24264 1.54839 7.65217 1.54839C11.0617 1.54839 13.8233 4.43548 13.8233 8C13.8233 11.5645 11.0617 14.4516 7.65217 14.4516ZM9.55905 11.0839L6.93941 9.09355C6.84376 9.01935 6.78822 8.90323 6.78822 8.78065V3.48387C6.78822 3.27097 6.95484 3.09677 7.15849 3.09677H8.14586C8.34951 3.09677 8.51613 3.27097 8.51613 3.48387V8.05484L10.5773 9.62258C10.7439 9.74839 10.7778 9.99032 10.6575 10.1645L10.0774 11C9.95708 11.171 9.72567 11.2097 9.55905 11.0839Z"
                    fill="#939393"
                  />
                </svg>
                {item.data.time_to_read ?? readingTime(item.body)}
              </span>
              <a
                class="ml-auto inline-flex items-center text-primary font-semibold hover:underline"
                href={buildPostLink(item.slug)}
              >
                {labels?.discover_more_label}
                <svg class="ml-1 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14m-7-7 7 7-7 7" />
                </svg>
              </a>
            </div>
          </div>
        </div>
      </div>
    ))
  }
  </div>
</div>
<script>
  const scopes = document.querySelectorAll('[data-search-scope="blog"]');
  scopes.forEach((scope) => {
    const input = scope.querySelector("[data-search-input]");
    const items = Array.from(scope.querySelectorAll("[data-search-item]"));
    const emptyState = scope.querySelector("[data-search-empty]");
    const count = scope.querySelector("[data-search-count]");

    if (!input) return;

    const update = () => {
      const query = input.value.trim().toLowerCase();
      const tokens = query.split(/\s+/).filter(Boolean);
      let visibleCount = 0;

      items.forEach((item) => {
        const haystack = (item.getAttribute("data-search-text") ?? "").toLowerCase();
        const matches = tokens.every((token) => haystack.includes(token));
        item.hidden = !matches;
        if (matches) visibleCount += 1;
      });

      if (emptyState) {
        emptyState.classList.toggle("hidden", visibleCount !== 0);
      }
      if (count) {
        count.textContent = query
          ? `${visibleCount}/${items.length}`
          : `${items.length}`;
      }
    };

    input.addEventListener("input", update);
    update();
  });
</script>
