---
import ChevronIcon from "./Chevron.astro"
import { LANGUAGES } from '@i18n/ui';
import { getRouteFromUrl, useTranslatedPath, getLangFromUrl } from '@i18n/utils';

const route = getRouteFromUrl(Astro.url);
const lang = getLangFromUrl(Astro.url);
const translatePath = await useTranslatedPath(lang);
const currentLocaleData = LANGUAGES[lang]
const otherLocales = Object.values(LANGUAGES).filter(
  (locale) => locale.code !== lang
)
---

<div class="relative inline-block text-left z-[100]">
  <div
    class="group text-white rounded-md text-xs font-semibold bg-overlay hover:bg-overlay_hover transition-all"
  >
    <button
      type="button"
      class="inline-flex justify-start items-center w-full gap-x-2 px-3 py-2"
      aria-expanded="true"
      aria-haspopup="true"
    >
      <currentLocaleData.flag />
      {currentLocaleData.name}
      <ChevronIcon />
    </button>
    <ul
      class="group-hover:block group-hover:animate-fade-down group-hover:animate-duration-200 hidden pt-0.5 absolute w-full"
    >
      {
        otherLocales.map((locale) => (

          <li class="py-[2px]">
            <a
              class="rounded-md bg-overlay hover:bg-overlay_hover whitespace-no-wrap inline-flex justify-start items-center w-full gap-x-2 px-3 py-2"
              data-lang-switch
              href={translatePath(`/${route ? route : ''}`, locale.code)}
            >
              <locale.flag />
              {locale.name}
            </a>
          </li>
        ))
      }
    </ul>
  </div>
</div>

<script>
  const SCROLL_STORAGE_KEY = 'lang-switch-scroll-ratio';

  function saveScrollPosition() {
    try {
      const doc = document.documentElement;
      const totalScrollable = doc.scrollHeight - window.innerHeight;

      let scrollY = window.scrollY || doc.scrollTop || 0;

      const isMobile = window.innerWidth < 992; // tu breakpoint
      let headerHeight = 0;
      let offset = 0;
      let scrollYAdjusted = scrollY;

      if (isMobile) {
        const header = document.querySelector('header');
        headerHeight = header && header.offsetHeight ? header.offsetHeight : 0;

        // ⚠️ IMPORTANTE:
        // En lugar de usar todo el headerHeight (391),
        // hacemos un offset razonable y estable.
        offset = Math.min(headerHeight || 80, 120); // máx 120px

        scrollYAdjusted = Math.max(0, scrollY - offset);
      }

      const ratio =
        totalScrollable > 0 ? scrollYAdjusted / totalScrollable : 0;

      console.log('[scroll-debug save]', {
        isMobile,
        scrollYOriginal: scrollY,
        headerHeight,
        offset,
        scrollYAdjusted,
        totalScrollable,
        ratio,
        innerHeight: window.innerHeight,
      });

      sessionStorage.setItem(
        SCROLL_STORAGE_KEY,
        JSON.stringify({ ratio })
      );
    } catch (error) {
      console.warn('No se pudo guardar la posición de scroll', error);
    }
  }

  function setupLanguageLinks() {
    document.querySelectorAll('[data-lang-switch]').forEach((link) => {
      if (link.dataset.scrollHandlerAttached === 'true') return;

      link.addEventListener('click', saveScrollPosition);
      link.dataset.scrollHandlerAttached = 'true';
    });
  }

  setupLanguageLinks();
  document.addEventListener('astro:after-swap', setupLanguageLinks);
</script>
