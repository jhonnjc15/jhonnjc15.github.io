---
import { Image } from 'astro:assets';
import config from "@config/config.json";
import dateFormat from "@lib/utils/dateFormat";
import readingTime from "@lib/utils/readingTime";
import Disqus from "./function-components/Disqus";
import ContentBreadcrumb from "./components/products/ContentBreadcrumb.astro";

import { humanize, slugify } from "@lib/utils/textConverter";
import { getRelativeLocaleUrl } from "astro:i18n";
import categoriesES from "@data/es/blog-categories.json";
import categoriesEN from "@data/en/blog-categories.json";
import Share from "./components/Share.astro";
const { blog_folder } = config.settings;
const { currentLocale } = Astro;
import {
  FaRegCalendarAlt,
  FaRegClock,
  FaRegFolder,
  FaRegUserCircle,
} from "react-icons/fa/index.js";
import { IoShareSocialOutline } from "react-icons/io5/index.js";

const { post } = Astro.props;
const { Content } = await post.render();
const categoryEntries = currentLocale === "en" ? categoriesEN : categoriesES;
const primaryCategory = post.data.categories?.[0];
const categoryEntry = primaryCategory
  ? categoryEntries.find((entry) => entry.category_name === primaryCategory)
  : undefined;
const categoryTitle = categoryEntry?.name ?? (primaryCategory ? humanize(primaryCategory) : undefined);
const categoryPath = primaryCategory ? `${blog_folder}/${slugify(primaryCategory)}` : undefined;
const heroImage = post.data.cover ?? post.data.image;
const breadcrumbData = {
  title: post.data.title,
  page_title: post.data.title,
  index_title: currentLocale === "en" ? "Blog" : "Blog",
  index_path: blog_folder,
  category_title: categoryTitle,
  category_path: categoryPath,
};
---

<section class="section blog-single relative overflow-hidden">
  <span class="absolute top-[500px] left-0 w-[360px] h-[220px] bg-gradient-to-tr from-secondary to-green-400 rounded-full blur-3xl opacity-25"></span>
  <span class="absolute top-0 right-8 w-[260px] h-[120px] bg-gradient-to-tr from-secondary to-green-400 rounded-full blur-3xl opacity-25"></span>
  <span class="absolute bottom-0 right-10 w-[240px] h-[180px] bg-gradient-to-tr from-primary to-green-400 rounded-full blur-2xl opacity-25"></span>
  <div class="container relative">
    <div class="mb-8 w-full">
      <ContentBreadcrumb data={breadcrumbData} />
    </div>
    <div class="row justify-center">
      <div class="lg:col-10" data-animate="zoom-in">
        <div class="relative overflow-hidden rounded-3xl shadow-2xl aspect-[16/9] bg-background-offset">
          <Image
            class="h-full w-full object-cover"
            src={heroImage}
            alt={post.data.title}
            width={1280}
            height={720}
          />
        </div>
      </div>
      <div class="mt-10 max-w-[900px] lg:col-9" data-animate="fade-up">
        <h1 class="h2 text-4xl md:text-5xl font-extrabold leading-tight">
          {post.data.title}
        </h1>
        <div class="mb-5 mt-6 flex flex-wrap items-center justify-between gap-4 text-text-offset">
          <ul class="flex flex-wrap items-center gap-x-4 gap-y-2">
            <li class="inline-flex items-center">
              <FaRegUserCircle className={"mr-2 -mt-1 inline-block"} />
              {humanize(post.data.author)}
            </li>

            <li class="inline-flex items-center">
              <FaRegCalendarAlt className={"mr-2 -mt-1 inline-block"} />
              {dateFormat(post.data.date)}
            </li>
            <li class="inline-flex items-center">
              <FaRegClock className={"mr-2 -mt-1 inline-block"} />
              {post.data.time_to_read ?? readingTime(post.body)}
            </li>
            <li class="inline-flex items-center gap-2">
              <FaRegFolder className={"-mt-1 inline-block"} />
              {
                post.data.categories.map((category: string, index: number) => (
                  <a
                    href={getRelativeLocaleUrl(
                      currentLocale ?? '',
                      `/${blog_folder}/${slugify(category)}`,
                    )}
                    class="hover:text-primary"
                  >
                    {humanize(category)}
                    {index !== post.data.categories.length - 1 && ","}
                  </a>
                ))
              }
            </li>
          </ul>
          <details class="relative" data-share-dropdown>
            <summary class="list-none">
              <span class="group relative inline-flex h-12 w-12 cursor-pointer items-center justify-center rounded-2xl border border-primary/40 bg-primary/20 text-lg text-primary shadow-lg shadow-primary/10 transition hover:border-primary hover:bg-primary/30 dark:border-primary/50">
                <IoShareSocialOutline />
                <span class="pointer-events-none absolute -top-9 left-1/2 z-20 -translate-x-1/2 whitespace-nowrap rounded-full bg-black/80 px-3 py-1 text-xs font-semibold text-white opacity-0 shadow-lg transition group-hover:opacity-100 dark:bg-white dark:text-black">
                  {currentLocale === "en" ? "Share" : "Compartir"}
                </span>
              </span>
            </summary>
            <div class="absolute right-0 z-10 mt-3 rounded-2xl border border-black/15 bg-white/95 px-4 py-3 shadow-xl shadow-primary/10 backdrop-blur dark:border-white/15 dark:bg-background/95">
              <Share
                className="flex items-center gap-2"
                title={post.data.title}
                description={post.data.subtitle ?? post.data.excerpt ?? ""}
                slug={post.slug}
                showCopy={true}
                copyLabel={currentLocale === "en" ? "Link Copied!" : "Link Copiado!"}
                forceLight={true}
              />
            </div>
          </details>
        </div>

        <div
          class="content prose prose-neutral max-w-none dark:prose-invert prose-a:text-primary dark:prose-a:text-primary"
          data-animate="fade-up"
        >
          <Content />
        </div>
        <div class="mt-10 border-t border-black/15 pt-8 dark:border-white/15">
          <h2 class="text-center text-lg font-semibold text-text-offset">
            {currentLocale === "en" ? "Share this post" : "Comparte este post"}
          </h2>
          <Share
            className="mt-4 flex flex-wrap items-center justify-center gap-3"
            title={post.data.title}
            description={post.data.subtitle ?? post.data.excerpt ?? ""}
            slug={post.slug}
            showCopy={true}
            copyLabel={currentLocale === "en" ? "Link Copied!" : "Link Copiado!"}
          />
        </div>
        <!-- <Disqus client:load /> -->
      </div>
    </div>
  </div>
</section>

<script is:inline>
  const getShareLists = () => document.querySelectorAll("[data-share-title]");
  const shareTitle = (list) => list.getAttribute("data-share-title") ?? "";
  const shareDescription = (list) => list.getAttribute("data-share-description") ?? "";
  const getCleanShareUrl = () => {
    const url = new URL(window.location.href);
    url.hash = "";
    return url.href.replace(/#$/, "");
  };
  const buildShareHref = (type, encodedUrl, title, description) => {
    if (type === "facebook") {
      return `https://facebook.com/sharer/sharer.php?u=${encodedUrl}`;
    }
    if (type === "linkedin") {
      return `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`;
    }
    if (type === "instagram") {
      return `https://www.instagram.com/share?url=${encodedUrl}`;
    }
    return "#";
  };

  const updateShareLinks = () => {
    getShareLists().forEach((list) => {
      const title = encodeURIComponent(shareTitle(list));
      const description = encodeURIComponent(shareDescription(list));
      const encodedUrl = encodeURIComponent(getCleanShareUrl());

      list.querySelectorAll("[data-share-link]").forEach((link) => {
        const type = link.getAttribute("data-share-link");
        if (!type) return;
        const href = buildShareHref(type, encodedUrl, title, description);
        link.setAttribute("href", href);
      });
    });
  };

  const bindShareInteractions = () => {
    updateShareLinks();

    document.querySelectorAll(".copy-link-button").forEach((button) => {
      if (button.dataset.copyBound === "true") return;
      button.dataset.copyBound = "true";
      button.addEventListener("click", async () => {
        const tooltip = button.querySelector(".copy-tooltip");
        try {
          await navigator.clipboard.writeText(getCleanShareUrl());
          if (tooltip) {
            tooltip.classList.add("opacity-100");
            tooltip.classList.remove("opacity-0");
            tooltip.classList.add("translate-x-1", "-translate-y-[110%]");
            tooltip.classList.remove("translate-x-0", "-translate-y-full", "-translate-x-2");
          }
          window.setTimeout(() => {
            if (tooltip) {
              tooltip.classList.remove("opacity-100");
              tooltip.classList.add("opacity-0");
              tooltip.classList.remove("translate-x-1", "-translate-y-[110%]");
              tooltip.classList.add("translate-x-0", "-translate-y-full", "-translate-x-2");
            }
          }, 1100);
        } catch (error) {
          console.error("Failed to copy link", error);
        }
      });
    });

    document.querySelectorAll("[data-share-link]").forEach((link) => {
      if (link.dataset.shareBound === "true") return;
      link.dataset.shareBound = "true";
      link.addEventListener("click", (event) => {
        event.preventDefault();
        const type = link.getAttribute("data-share-link");
        if (!type) return;
        const list = link.closest("[data-share-title]");
        if (!list) return;
        const shareUrl = encodeURIComponent(getCleanShareUrl());
        const title = encodeURIComponent(shareTitle(list));
        const description = encodeURIComponent(shareDescription(list));
        const href = buildShareHref(type, shareUrl, title, description);
        if (href === "#") return;
        window.open(href, "_blank", "noopener,noreferrer");
      });
    });
  };

  bindShareInteractions();
  document.addEventListener("astro:page-load", bindShareInteractions);

  document.addEventListener("click", (event) => {
    document.querySelectorAll("[data-share-dropdown]").forEach((dropdown) => {
      if (!dropdown.hasAttribute("open")) return;
      if (dropdown.contains(event.target)) return;
      dropdown.removeAttribute("open");
    });
  });
</script>
