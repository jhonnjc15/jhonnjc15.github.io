---
import PageHeader from "@components/PageHeader.astro";
import Base from "@layouts/Base.astro";
import Blogs from "@components/Blogs.astro";
import BlogCategories from "@components/blog/BlogCategories.astro";
import Pagination from "@layouts/components/Pagination.astro";
import config from "@config/config.json";
import { getCollection, getEntryBySlug } from "astro:content";
import { sortByDate } from "@lib/utils/sortFunctions";
import { filterByLocale } from "@lib/utils/filterByLocale";

import categoriesES from "@data/es/blog-categories.json";
import categoriesEN from "@data/en/blog-categories.json";

const { currentLocale } = Astro;
const fallbackLocale = "es";
const { blog_folder, pagination } = config.settings;

const categoryEntries = currentLocale === "en" ? categoriesEN : categoriesES;
const categories = categoryEntries.map((entry) => entry.category_name);

const allPosts = await getCollection("blog");

const normalizeSlug = (slug: string) => slug.split("/").slice(1).join("/");

let localePosts = filterByLocale(allPosts, currentLocale ?? fallbackLocale);

if (localePosts.length === 0 && currentLocale !== fallbackLocale) {
  localePosts = filterByLocale(allPosts, fallbackLocale);
}

const posts = localePosts
  .filter((entry) => !entry.data.draft)
  .map((entry) => ({
    ...entry,
    slug: normalizeSlug(entry.slug),
  }));

const sortedPosts = sortByDate(posts);
const totalPages = Math.ceil(sortedPosts.length / pagination) || 1;
const currentPosts = sortedPosts.slice(0, pagination);

let blogIndex = await getEntryBySlug("pages", `${currentLocale}/blog-index`);

if (!blogIndex) {
  blogIndex = await getEntryBySlug("pages", `${fallbackLocale}/blog-index`);
}

const copy = blogIndex?.data ?? { title: "Blog", description: "" };

const page_data = {
  title: copy.title,
  page_title: copy.title,
  content: copy.description,
};

export async function getStaticPaths() {
  return [{ params: { lang: "es" } }, { params: { lang: "en" } }];
}
---
<Base title={copy.title} description={copy.description}>
  <section class="page-hero pb-4 pt-16" data-animate="fade-up">
    <div class="container">
      <PageHeader page_data={page_data} />
    </div>
  </section>
  <section class="section mx-4 md:mx-10 lg:mx-20 mt-12" data-animate="zoom-in">
    <BlogCategories categories={categories} />
    <Blogs posts={currentPosts} basePath={blog_folder} />
    <Pagination
      section={blog_folder}
      currentPage={1}
      totalPages={totalPages}
    />
  </section>
</Base>
