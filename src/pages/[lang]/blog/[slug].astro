---
import Base from "@layouts/Base.astro";
import Shape from "@components/Shape.astro";
import BlogSingle from "@layouts/BlogSingle.astro";
import { getCollection, getEntryBySlug } from "astro:content";
import { filterByLocale } from "@lib/utils/filterByLocale";
const { currentLocale } = Astro;
const fallbackLocale = "es";

export async function getStaticPaths() {
  const locales = ["es", "en"];
  const posts = await getCollection("blog");

  return locales.flatMap((lang) =>
    filterByLocale(posts, lang)
      .filter((post) => post.data.show !== false)
      .map((post) => ({
        params: {
          lang,
          slug: post.slug.split("/").slice(1).join("/"),
        },
      }))
  );
}

const { slug } = Astro.params;

let post = await getEntryBySlug("blog", `${currentLocale}/${slug}`);

if (!post && currentLocale !== fallbackLocale) {
  post = await getEntryBySlug("blog", `${fallbackLocale}/${slug}`);
}

if (!post) {
  throw new Error(`Blog post not found for slug ${slug}`);
}

if (post.data.show === false) {
  throw new Error(`Blog post hidden for slug ${slug}`);
}

const pageTitle = post.data.title;
const pageDescription = post.data.subtitle ?? post.data.excerpt ?? "";

---
<Base title={pageTitle} description={pageDescription} image={post.data.image}>
  <Shape />
  <BlogSingle post={post} />
</Base>
