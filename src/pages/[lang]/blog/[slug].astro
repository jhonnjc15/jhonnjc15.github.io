---
import Base from "@layouts/Base.astro";
import Shape from "@components/Shape.astro";
import BlogSingle from "@layouts/BlogSingle.astro";
import { getCollection, getEntryBySlug } from "astro:content";
import { filterByLocale } from "@lib/utils/filterByLocale";
import config from "@config/config.json";
import sharp from "sharp";
import { fileURLToPath } from "url";
const { currentLocale } = Astro;
const fallbackLocale = "es";

export async function getStaticPaths() {
  const locales = ["es", "en"];
  const posts = await getCollection("blog");

  return locales.flatMap((lang) =>
    filterByLocale(posts, lang)
      .filter((post) => post.data.show !== false)
      .map((post) => ({
        params: {
          lang,
          slug: post.slug.split("/").slice(1).join("/"),
        },
      }))
  );
}

const { slug } = Astro.params;

let post = await getEntryBySlug("blog", `${currentLocale}/${slug}`);

if (!post && currentLocale !== fallbackLocale) {
  post = await getEntryBySlug("blog", `${fallbackLocale}/${slug}`);
}

if (!post) {
  throw new Error(`Blog post not found for slug ${slug}`);
}

if (post.data.show === false) {
  throw new Error(`Blog post hidden for slug ${slug}`);
}

const pageTitle = post.data.title;
const pageDescription = post.data.subtitle ?? post.data.excerpt ?? "";
const fallbackImage = config.metadata.meta_image;
const imagePath = post.data.ogImage ?? post.data.cover ?? post.data.image ?? fallbackImage;
const absoluteImageUrl = Astro.site
  ? new URL(imagePath, Astro.site).href
  : `${config.site.base_url}${imagePath}`;
const isLocalImage = imagePath?.startsWith("/");
const ogImageType = imagePath?.endsWith(".png")
  ? "image/png"
  : imagePath?.endsWith(".jpg") || imagePath?.endsWith(".jpeg")
    ? "image/jpeg"
    : undefined;
let ogImageWidth;
let ogImageHeight;

if (isLocalImage) {
  const imageFileUrl = new URL(`../../../../public${imagePath}`, import.meta.url);

  try {
    const metadata = await sharp(fileURLToPath(imageFileUrl)).metadata();
    ogImageWidth = metadata.width;
    ogImageHeight = metadata.height;
  } catch (error) {
    console.warn(`Unable to read OG image metadata for ${imagePath}.`, error);
  }
}

---
<Base title={pageTitle} description={pageDescription} disableOg={true}>
  <Fragment slot="head">
    <meta property="og:type" content="article" />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:url" content={Astro.url.href} />
    <meta property="og:image" content={absoluteImageUrl} />
    {ogImageType && <meta property="og:image:type" content={ogImageType} />}
    {ogImageWidth && <meta property="og:image:width" content={String(ogImageWidth)} />}
    {ogImageHeight && <meta property="og:image:height" content={String(ogImageHeight)} />}

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDescription} />
    <meta name="twitter:image" content={absoluteImageUrl} />
  </Fragment>
  <!--<Shape />-->
  <BlogSingle post={post} />
</Base>
