---
import PageHeader from "@components/PageHeader.astro";
import Shape from "@components/Shape.astro";
import Base from "@layouts/Base.astro";
import Blogs from "@components/Blogs.astro";
import BlogCategories from "@components/blog/BlogCategories.astro";
import Pagination from "@layouts/components/Pagination.astro";
import config from "@config/config.json";
import { getCollection, getEntryBySlug } from "astro:content";
import { sortByDate } from "@lib/utils/sortFunctions";
import { filterByLocale } from "@lib/utils/filterByLocale";

import categoriesES from "@data/es/blog-categories.json";
import categoriesEN from "@data/en/blog-categories.json";

const { currentLocale } = Astro;
const fallbackLocale = "es";
const { blog_folder, pagination } = config.settings;

const categoryEntries = currentLocale === "en" ? categoriesEN : categoriesES;
const { category, slug } = Astro.params;

const activeCategory = categoryEntries.find(
  (entry) => entry.category_name === category,
);

if (!activeCategory) {
  throw new Error(`Category not found: ${category}`);
}

const categories = categoryEntries.map((entry) => entry.category_name);

const allPosts = await getCollection("blog");
const normalizeSlug = (slug: string) => slug.split("/").slice(1).join("/");

let localePosts = filterByLocale(allPosts, currentLocale ?? fallbackLocale);

if (localePosts.length === 0 && currentLocale !== fallbackLocale) {
  localePosts = filterByLocale(allPosts, fallbackLocale);
}

const posts = localePosts
  .filter((entry) => !entry.data.draft)
  .filter((entry) => entry.data.categories.includes(category))
  .map((entry) => ({
    ...entry,
    slug: normalizeSlug(entry.slug),
  }));

const sortedPosts = sortByDate(posts);
const totalPages = Math.ceil(sortedPosts.length / pagination) || 1;
const currentPage = slug && !isNaN(Number(slug)) ? Number(slug) : 1;
const indexOfLastPost = currentPage * pagination;
const indexOfFirstPost = indexOfLastPost - pagination;
const currentPosts = sortedPosts.slice(indexOfFirstPost, indexOfLastPost);

let blogUi = await getEntryBySlug("pages", `${currentLocale}/blog-ui`);
if (!blogUi) {
  blogUi = await getEntryBySlug("pages", `${fallbackLocale}/blog-ui`);
}

const blogLabels = blogUi?.data ?? {};

const page_data = {
  index_title: activeCategory.name,
  page_title: `${activeCategory.name} / ${slug}`,
  slug: `page / ${slug}`,
  index_path: `${blog_folder}/${category}`,
  content: activeCategory.long_description ?? "",
};

export async function getStaticPaths() {
  const locales = ["es", "en"];
  const entries = await getCollection("blog");
  const paths: { params: { lang: string; category: string; slug: string } }[] = [];
  const pageSize = config.settings.pagination;

  for (const lang of locales) {
    const categoriesData = lang === "en" ? categoriesEN : categoriesES;

    for (const entry of categoriesData) {
      const posts = filterByLocale(entries, lang)
        .filter((post) => !post.data.draft)
        .filter((post) => post.data.categories.includes(entry.category_name));

      const pages = Math.ceil(posts.length / pageSize) || 1;

      for (let page = 2; page <= pages; page++) {
        paths.push({
          params: {
            lang,
            category: entry.category_name,
            slug: page.toString(),
          },
        });
      }
    }
  }

  return paths;
}
---
<Base title={activeCategory.name} description={activeCategory.short_description}>
  <Shape />
  <section class="page-hero pt-12">
    <div class="container">
      <PageHeader page_data={page_data} />
    </div>
  </section>
  <section class="section mx-4 md:mx-10 lg:mx-20 mt-12">
    <BlogCategories categories={categories} labels={blogLabels} />
    <Blogs posts={currentPosts} basePath={blog_folder} labels={blogLabels} />
    <Pagination
      section={`${blog_folder}/${category}`}
      totalPages={totalPages}
      currentPage={currentPage}
    />
  </section>
</Base>
