---
import Base from "@layouts/Base.astro";
import ProductPage from "@components/products/ProductPage.astro";
import productsES from "@data/es/products.json";
import productsEN from "@data/en/products.json";
import { getProductSlug } from "@lib/utils/productSlug";

const { currentLocale } = Astro;

const products = currentLocale === "en" ? productsEN : productsES;

interface ProductData {
  id_product: number;
  title: string;
  description?: string;
  features?: string[];
  price_soles?: number;
  price_note?: string;
  youtube_videos?: string[];
  blog_articles?: { title: string; url: string }[];
  pdf_guides?: { title: string; url: string }[];
  related_products?: number[];
  purchase_context?: string;
  available?: boolean;
  show?: boolean;
  images?: { src: string; isMain?: boolean }[];
}

export async function getStaticPaths() {
  const locales = ["es", "en"];
  const paths: { params: { lang: string; slug: string } }[] = [];

  for (const lang of locales) {
    const localeProducts = (lang === "en" ? productsEN : productsES).filter((product) => product.show !== false);

    for (const product of localeProducts) {
      paths.push({
        params: {
          lang,
          slug: getProductSlug(product),
        },
      });
    }
  }

  return paths;
}

const { slug } = Astro.params;

const product = products
  .filter((entry) => entry.show !== false)
  .find((entry) => getProductSlug(entry) === slug) as ProductData | undefined;

if (!product) {
  throw new Error(`Product not found for slug ${slug}`);
}

const pageTitle = product.title;
const pageDescription = product.description ?? "";

---
<Base
  title={pageTitle}
  meta_title={pageTitle}
  description={pageDescription}
>
  <div class="px-5 my-10 mx-4 md:mx-10 lg:mx-20">
    <ProductPage data_by_id={product} />
  </div>
</Base>
